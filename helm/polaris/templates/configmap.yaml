{{/*
  Copyright (c) 2024 Snowflake Computing Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "polaris.fullname" . }}
  labels:
    {{- include "polaris.labels" . | nindent 4 }}
    {{- if .Values.configMapLabels }}
    {{- tpl (toYaml .Values.configMapLabels) . | nindent 4 }}
    {{- end }}
data:
  polaris-server.yml: |-
    server:
      maxThreads: {{ .Values.polaris_config.server.maxThreads }}
      minThreads: {{ .Values.polaris_config.server.minThreads }}
      applicationConnectors:
        - type: http
          port: {{ index .Values "service" "ports" "polaris-service" }}
      adminConnectors:
        - type: http
          port: {{ index .Values "service" "ports" "polaris-metrics" }}
      {{- if .Values.polaris_config.server.bindHost }}
      bindHost: {{ .Values.polaris_config.server.bindHost }}
      {{- end }}
      {{- if .Values.polaris_config.server.ssl }}
      ssl:
        keyStore: {{ .Values.polaris_config.server.ssl.keyStore }}
        keyStorePassword: {{ .Values.polaris_config.server.ssl.keyStorePassword }}
        {{- if .Values.polaris_config.server.ssl.keyStoreType }}
        keyStoreType: {{ .Values.polaris_config.server.ssl.keyStoreType }}
        {{- end }}
      {{- end }}
      requestLog:
        appenders:
        {{- range .Values.polaris_config.server.requestLog.appenders }}
          - type: {{ .type }}
            {{- if .currentLogFilename }}
            currentLogFilename: {{ .currentLogFilename }}
            archivedLogFilenamePattern: {{ .archivedLogFilenamePattern }}
            archivedFileCount: {{ .archivedFileCount }}
            archive: {{ .archive }}
            {{- end }}
        {{- end }}
    
    baseCatalogType: "{{ .Values.polaris_config.baseCatalogType }}"

    featureConfiguration:
      ENFORCE_PRINCIPAL_CREDENTIAL_ROTATION_REQUIRED_CHECKING: {{ .Values.polaris_config.featureConfiguration.ENFORCE_PRINCIPAL_CREDENTIAL_ROTATION_REQUIRED_CHECKING }}
      DISABLE_TOKEN_GENERATION_FOR_USER_PRINCIPALS: {{ .Values.polaris_config.featureConfiguration.DISABLE_TOKEN_GENERATION_FOR_USER_PRINCIPALS }}
      SUPPORTED_CATALOG_STORAGE_TYPES:
      {{- range .Values.polaris_config.featureConfiguration.SUPPORTED_CATALOG_STORAGE_TYPES }}
        - {{ . }}
      {{- end }}
    
    callContextResolver:
      type: {{ .Values.polaris_config.callContextResolver.type }}
    
    realmContextResolver:
      type: {{ .Values.polaris_config.realmContextResolver.type }}
    
    defaultRealms:
    {{- range .Values.polaris_config.defaultRealms }}
      - {{ . }}
    {{- end }}
    
    metaStoreManager:
      type: {{ .Values.polaris_config.metaStoreManager.type }}
      {{- if index .Values "polaris_config" "metaStoreManager" "persistence-unit" }}
      persistence-unit: {{ index .Values "polaris_config" "metaStoreManager" "persistence-unit" }}
      {{- end }}
      {{- if index .Values "polaris_config" "metaStoreManager" "conf-file" }}
      conf-file: {{ index .Values "polaris_config" "metaStoreManager" "conf-file" }}
      {{- end }}

    oauth2:
      type: {{ .Values.polaris_config.oauth2.type }}
      {{- if .Values.polaris_config.oauth2.tokenBroker }}
      tokenBroker:
        type: {{ .Values.polaris_config.oauth2.tokenBroker.type }}
        secret: {{ .Values.polaris_config.oauth2.tokenBroker.secret }}
      {{- end }}

    authenticator:
      class: {{ .Values.polaris_config.authenticator.class }}
      {{- if .Values.polaris_config.authenticator.tokenBroker }}
      tokenBroker:
        type: {{ .Values.polaris_config.authenticator.tokenBroker.type }}
        secret: {{ .Values.polaris_config.authenticator.tokenBroker.secret }}
      {{- end }}

    cors:
      allowed-origins:
      {{- range $_, $value := index .Values "polaris_config" "cors" "allowed-origins" }}
        - {{ $value }}
      {{- end }}
      allowed-timing-origins:
      {{- range $_, $value := index .Values "polaris_config" "cors" "allowed-timing-origins" }}
        - {{ $value }}
      {{- end }}
      allowed-methods:
      {{- range $_, $value := index .Values "polaris_config" "cors" "allowed-methods" }}
        - {{ $value }}
      {{- end }}
      allowed-headers:
      {{- range $_, $value := index .Values "polaris_config" "cors" "allowed-headers" }}
        - "{{ $value }}"
      {{- end }}
      exposed-headers:
      {{- range $_, $value := index .Values "polaris_config" "cors" "exposed-headers" }}
        - "{{ $value }}"
      {{- end }}
      preflight-max-age: {{ index .Values "polaris_config" "cors" "preflight-max-age" }}
      allowed-credentials: {{ index .Values "polaris_config" "cors" "allowed-credentials" }}
    
    logging:
      level: {{ .Values.polaris_config.logging.level }}
      loggers:
      {{- range $key, $value := .Values.polaris_config.logging.loggers }}
        {{ $key }}: {{ $value }}
      {{- end }}
      appenders:
      {{- range .Values.polaris_config.logging.appenders }}
        - type: {{ .type }}
          threshold: {{ .threshold }}
          {{- if .logFormat }}
          logFormat: "{{ .logFormat }}"
          {{- end }}
          {{- if .layout }}
          layout:
            type: {{ .layout.type }}
            flattenKeyValues: {{ .layout.flattenKeyValues }}
            includeKeyValues: {{ .layout.includeKeyValues }}
          {{- end }}
          {{- if .currentLogFilename }}
          currentLogFilename: {{ .currentLogFilename }}
          {{- end }}
          {{- if .archivedLogFilenamePattern }}
          archivedLogFilenamePattern: {{ .archivedLogFilenamePattern }}
          {{- end }}
          {{- if .archivedFileCount }}
          archivedFileCount: {{ .archivedFileCount }}
          {{- end }}
      {{- end }}